<!DOCTYPE html>
<html lang='ja'>
<head>
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weibull Distribution Fitting</title>
  <link rel="stylesheet" href="vendor/kube500/css/kube.css" />
  <link rel="stylesheet" href="css/common.css" />
  <link href="./vendor/c3-0.4.10/c3.css" rel="stylesheet" type="text/css">
  <style>
  #result {
    display: none;
    margin-top: 30px;
  }

  #value-area {
    background-color: #D9F4E1;
  }

  #draw-area {
    background-color: white;
  }

  </style>
</head>
<body>
  <div class="wrap content">
    <h1>Weibull Distribution Fitting</h1>
    <form class="forms">
      <row>
        <column cols="12">
          <label>Raw Datas<span class="desc">( CSV or TSV format )</span></label>
          <textarea id="rawdata" rows="5" required>
0.1, 0.19
0.2, 0.28
0.3, 0.44
0.4, 0.78
0.5, 0.67
0.6, 0.73
0.7, 0.65
0.8, 0.64
0.9, 0.60
1.0, 0.50
1.3, 0.30
1.5, 0.05</textarea>
      </row>
      <fieldset>
        <legend>A <span class="desc">( shape parameter )</span></legend>
        <row>
          <column cols="5">
            <label>start <span class="desc">( >0 )</span></label>
            <input type="text" id="a-start" value="0.1" pattern="^[0-9\.]*$" required/>
          </column>
          <column cols="5">
            <label>end <span class="desc">( >0 )</span></label>
            <input type="text" id="a-end" value="5" pattern="^[0-9\.]*$" required/>
          </column>
          <column cols="5">
            <label>step <span class="desc">( >0 )</span></label>
            <input type="text" id="a-step" value="0.01" pattern="^[0-9\.]*$" required/>
          </column>
        </row>
      </fieldset>
      <fieldset>
        <legend>B <span class="desc">( scale parameter )</span></legend>
        <row>
          <column cols="5">
            <label>start <span class="desc">( >0 )</span></label>
            <input type="text" id="b-start" value="0.1" pattern="^[0-9\.]*$" required/>
          </column>
          <column cols="5">
            <label>end <span class="desc">( >0 )</span></label>
            <input type="text" id="b-end" value="5" pattern="^[0-9\.]*$" required/>
          </column>
          <column cols="5">
            <label>step <span class="desc">( >0 )</span></label>
            <input type="text" id="b-step" value="0.01" pattern="^[0-9\.]*$" required/>
          </column>
        </row>
      </fieldset>
      <row>
        <column cols="2">
          <button type="primary" onclick="main.calc(); return false;" round>Calculate</button>
        </column>
        <column cols="7">
          <div class="alert alert-error" >aaa</div>
        </column>
      </row>

    </form>
    <div id="result">
      <fieldset id="value-area">
        <row>
          <column cols="5">
            <label>a <span class="desc">( shape parameter )</span></label>
            <input type="text" id="a" disabled="true" />
          </column>
          <column cols="5">
            <label>b <span class="desc">( scale parameter )</span></label>
            <input type="text" id="b" disabled="true" />
          </column>
          <column cols="5">
            <label>rss <span class="desc">( residual sum of squares )</span></label>
            <input type="text" id="rss" disabled="true" />
          </column>
        </row>
      </fieldset>
      <div id="draw-area" class="area"><div id="chart"></div></div>
    </div>
  </div>

  <script src="./vendor/d3/d3.js" charset="utf-8"></script>
  <script src="./vendor/c3-0.4.10/c3.js" charset="utf-8"></script>
  <script>
    var main = function() {

      var calc = function() {
        reset();

        if (!document.forms[0].checkValidity()) {
          d3.select('.alert').text('Input value is invalid. Please re-check the values.').style('display', 'block');
          return;
        }

        var a_start = document.getElementById("a-start").value-0;
        var a_end = document.getElementById("a-end").value-0;
        var a_step = document.getElementById("a-step").value-0;
        var b_start = document.getElementById("b-start").value-0;
        var b_end = document.getElementById("b-end").value-0;
        var b_step = document.getElementById("b-step").value-0;


        // get rawdata
        var rawdata = d3.csv.parseRows(document.getElementById("rawdata").value.replace(/\t/g, ","), function(d) {
          return {'x': d[0].trim()-0, 'y': d[1].trim()-0};
        });

        // fitting
        var result = {'a': 0, 'b': 0, 'rss': 99999};
        for(var a = a_start; a <= a_end; a += a_step) {
          for(var b = b_start; b <= b_end; b += a_step) {
            var rss = 0;
            d3.values(rawdata).forEach(function(data){
              rss += Math.pow(data.y - calcWeibull(a,b,data.x), 2);
            });
            if (rss < result.rss) {
              result = {'a': a, 'b': b, 'rss': rss};
            }
          }
        }

        // show results
        d3.select('#a').attr('value', round(result.a));
        d3.select('#b').attr('value', round(result.b));
        d3.select('#rss').attr('value', round(result.rss));
        d3.select('#result').style('display', 'block');

        // draw chart
        draw();
      };

      function draw() {

        // get line chart data
        var a = document.getElementById("a").value-0;
        var b = document.getElementById("b").value-0;
        var calc_x = [];
        var calc_y = [];
        for (var x = 0, i = 0; x <= 5; x += 0.1, i++) {
          calc_x[i] = round(x);
          calc_y[i] = round(calcWeibull(a, b, x));
        }

        // get plot data
        var x = [], y = [];
        var rawdata = d3.csv.parseRows(document.getElementById("rawdata").value.replace(/\t/g, ","), function(d, i) {
          x[i] = round(d[0].trim());
          y[i] = round(d[1].trim());
        });


        // draw chart
        var chart = c3.generate({
          data: {
            xs: {
              'weibull curve': 'x1',
              'rawdata': 'x2'
            },
            columns: [
              ['x1'].concat(calc_x),
              ['weibull curve'].concat(calc_y),
              ['x2'].concat(x),
              ['rawdata'].concat(y),
            ],
            type: 'spline'
          }
        });

      };

      function calcWeibull(a, b, x) {
        if (x <= 0) {
          return 0;
        } else {
          return a/b * Math.pow(x/b, a-1) * Math.exp(-Math.pow(x/b, a));
        }
      };
      return {"calc": calc};

      function reset() {
        d3.select('.alert').style('display', 'none');
        d3.select('#result').style('display', 'none');
        d3.select('#a').attr('value', '');
        d3.select('#b').attr('value', '');
        d3.select('#rss').attr('value', '');
      }

      function round(value, digit) {
        var num = Math.pow(10, (!!digit || 3));
        return Math.round(value * num) / num;
      }

    }();

  </script>
</body>
</html>

