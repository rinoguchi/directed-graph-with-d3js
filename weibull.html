<!DOCTYPE html>
<html lang='ja'>
<head>
  <!-- common -->
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="bower_components/kube500/css/kube.css" />
  <link rel="stylesheet" href="css/common.css" />

  <!-- this page -->
  <link href="bower_components/c3/c3.css" rel="stylesheet" type="text/css">

  <title>Weibull Distribution Fitting</title>
  <style>
  #result {
    display: none;
    margin-top: 30px;
  }

  #value-area {
    background-color: #D9F4E1;
  }

  #draw-area {
    background-color: white;
  }
  </style>

  <script src="bower_components/d3/d3.min.js" charset="utf-8"></script>
  <script src="bower_components/c3/c3.min.js" charset="utf-8"></script>
  <script src="bower_components/jquery/dist/jquery.min.js" charset="utf-8"></script>
  <!-- jQuery を追加 -->
  <script>
    $(function(){

      $('#calc').click(function(e) {
        e.preventDefault();
        before();
        calc();
        draw();
        after();
      });

      $('#draw').click(function(e) {
        e.preventDefault();
        draw();
      });

      function before() {
        $('.alert').hide();
        $('#result').hide();
        $('#calc').attr('disabled', true);
      }

      function after() {
        $('#result').show();
        $('#calc').attr('disabled', false);
      }

      function calc() {

        if (!document.forms[0].checkValidity()) {
          d3.select('.alert').text('Input value is invalid. Please check the values.').style('display', 'block');
          return;
        }

        var a_from = $('#a-from').val()-0;
        var a_to = $('#a-to').val()-0;
        var a_step = $('#a-step').val()-0;
        var b_from = $('#b-from').val()-0;
        var b_to = $('#b-to').val()-0;
        var b_step = $('#b-step').val()-0;
        var r_from = $('#r-from').val()-0;
        var r_to = $('#r-to').val()-0;
        var r_step = $('#r-step').val()-0;
        var m_from = $('#m-from').val()-0;
        var m_to = $('#m-to').val()-0;
        var m_step = $('#m-step').val()-0;


        // get rawdata
        var rawdata = d3.csv.parseRows($('#rawdata').val().replace(/\t/g, ','), function(d) {
          return {'x': d[0].trim()-0, 'y': d[1].trim()-0};
        });

        // fitting
        var result = {'a': 0, 'b': 0, 'r': 0, 'm': 1, 'rss': 99999};
        for(var m = m_from; m <= m_to; m += m_step) {
          for(var r = r_from; r <= r_to; r += r_step) {
            for(var a = a_from; a <= a_to; a += a_step) {
              for(var b = b_from; b <= b_to; b += a_step) {
                var rss = 0;
                d3.values(rawdata).forEach(function(data){
                  rss += Math.pow(data.y - calcWeibull(a, b, r, m, data.x), 2);
                });
                if (rss < result.rss) {
                  result = {'a': a, 'b': b, 'r': r, 'm': m, 'rss': rss};
                }
              }
            }
          }
        }

        // set results
        $('#a').val(round(result.a));
        $('#b').val(round(result.b));
        $('#r').val(round(result.r));
        $('#m').val(round(result.m));
        $('#rss').val(round(result.rss));

      };

      function draw() {

        // get line chart data
        var a = $('#a').val()-0;
        var b = $('#b').val()-0;
        var r = $('#r').val()-0;
        var m = $('#m').val()-0;
        var calc_x = [];
        var calc_y = [];
        for (var x = 0, i = 0; x <= 5; x += 0.1, i++) {
          calc_x[i] = round(x);
          calc_y[i] = round(calcWeibull(a, b, r, m, x));
        }

        // get plot data
        var x = [], y = [];
        var rawdata = d3.csv.parseRows($('#rawdata').val().replace(/\t/g, ','), function(d, i) {
          x[i] = round(d[0].trim());
          y[i] = round(d[1].trim());
        });


        // draw chart
        var chart = c3.generate({
          data: {
            xs: {
              'weibull curve': 'x1',
              'rawdata': 'x2'
            },
            columns: [
              ['x1'].concat(calc_x),
              ['weibull curve'].concat(calc_y),
              ['x2'].concat(x),
              ['rawdata'].concat(y),
            ],
            type: 'spline'
          }
        });

      };

      function calcWeibull(a, b, r, m, x) {
        if (x <= 0) {
          return 0;
        } else {
          return a/b * Math.pow((x-r)/b, a-1) * Math.exp(-Math.pow((x-r)/b, a)) * m ;
        }
      };

      function round(value, digit) {
        var num = Math.pow(10, (!!digit || 3));
        return Math.round(value * num) / num;
      }

    });
  </script>

</head>
<body>
  <div class="wrap content">
    <h1>Weibull Distribution Fitting</h1>
    <form class="forms">
      <row>
        <column cols="5">
          <h5>Raw Datas<span class="desc">( CSV or TSV format )</span></h5>
          <textarea id="rawdata" rows="18" required>
0.1, 0.1
0.2, 0.28
0.3, 0.44
0.4, 0.7
0.5, 0.82
0.6, 0.85
0.7, 0.8
0.8, 0.7
0.9, 0.60
1.0, 0.50
1.3, 0.2
1.5, 0.05</textarea>
        </column>
        <column cols="10">
          <h5>Calculation Settings</h5>
          <fieldset>
            <legend>a <span class="desc">( shape parameter )</span></legend>
            <row>
              <column cols="5">
                <label>from <span class="desc">( >0 )</span></label>
                <input type="text" id="a-from" value="0.1" pattern="^[0-9\.]*$" required/>
              </column>
              <column cols="5">
                <label>to <span class="desc">( >0 )</span></label>
                <input type="text" id="a-to" value="5" pattern="^[0-9\.]*$" required/>
              </column>
              <column cols="5">
                <label>step <span class="desc">( >0 )</span></label>
                <input type="text" id="a-step" value="0.1" pattern="^[0-9\.]*$" required/>
              </column>
            </row>
          </fieldset>
          <fieldset>
            <legend>b <span class="desc">( scale parameter )</span></legend>
            <row>
              <column cols="5">
                <label>from <span class="desc">( >0 )</span></label>
                <input type="text" id="b-from" value="0.1" pattern="^[0-9\.]*$" required/>
              </column>
              <column cols="5">
                <label>to <span class="desc">( >0 )</span></label>
                <input type="text" id="b-to" value="5" pattern="^[0-9\.]*$" required/>
              </column>
              <column cols="5">
                <label>step <span class="desc">( >0 )</span></label>
                <input type="text" id="b-step" value="0.1" pattern="^[0-9\.]*$" required/>
              </column>
            </row>
          </fieldset>
          <fieldset>
            <legend>r <span class="desc">( location parameter )</span></legend>
            <row>
              <column cols="5">
                <label>from <span class="desc"></span></label>
                <input type="text" id="r-from" value="0" pattern="^[\-0-9\.]*$" required/>
              </column>
              <column cols="5">
                <label>to <span class="desc"></span></label>
                <input type="text" id="r-to" value="0" pattern="^[\-0-9\.]*$" required/>
              </column>
              <column cols="5">
                <label>step <span class="desc">( >0 )</span></label>
                <input type="text" id="r-step" value="0.1" pattern="^[0-9\.]*$" required/>
              </column>
            </row>
          </fieldset>
          <fieldset>
            <legend>m <span class="desc">( magnification of vertical axis )</span></legend>
            <row>
              <column cols="5">
                <label>from <span class="desc">( >0 )</span></label>
                <input type="text" id="m-from" value="1" pattern="^[0-9\.]*$" required/>
              </column>
              <column cols="5">
                <label>to <span class="desc">( >0 )</span></label>
                <input type="text" id="m-to" value="1" pattern="^[0-9\.]*$" required/>
              </column>
              <column cols="5">
                <label>step <span class="desc">( >0 )</span></label>
                <input type="text" id="m-step" value="0.1" pattern="^[0-9\.]*$" required/>
              </column>
            </row>
          </fieldset>

        </column>
      </row>
      <row>
        <column cols="2">
          <button type="primary" id="calc" round>Calculate</button>
        </column>
        <column cols="7">
          <div class="alert alert-error" ></div>
        </column>
      </row>
      <div id="result">
      <h5>Result</h5>
      <fieldset id="value-area">
        <row>
          <column cols="2">
            <label>a <span class="desc">( shape )</span></label>
            <input type="text" id="a" disabled="true" />
          </column>
          <column cols="2">
            <label>b <span class="desc">( scale )</span></label>
            <input type="text" id="b" disabled="true" />
          </column>
          <column cols="2">
            <label>r <span class="desc">( location )</span></label>
            <input type="text" id="r" disabled="true" />
          </column>
          <column cols="2">
            <label>m <span class="desc">( magnification )</span></label>
            <input type="text" id="m" disabled="true" />
          </column>
          <column cols="2">
            <label>RSS <span class="desc"></span></label>
            <input type="text" id="rss" disabled="true" />
          </column>
        </row>
      </fieldset>
      <div id="draw-area" class="area"><div id="chart"></div></div>
    </div>
    </form>
  </div>
</body>
</html>

